name: PyLops

on: [push, pull_request]

jobs:
  build:
    strategy:
      matrix:
        platform: [ ubuntu-latest, macos-latest ]
        python-version: ["3.10", "3.11"]   # ðŸš« 3.12 removido

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # necessÃ¡rio para setuptools_scm

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # =========================
      # Linux
      # =========================
      - name: Install OpenMPI on Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openmpi-bin \
            libopenmpi-dev \
            build-essential

      # =========================
      # macOS
      # =========================
      - name: Install OpenMPI + GCC on macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install open-mpi gcc

      - name: Configure compiler for Devito (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV

      # =========================
      # Python deps
      # =========================
      - name: Install base Python dependencies
        run: |
          pip install --upgrade pip
          pip install setuptools wheel setuptools_scm flake8 pytest mpi4py
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      # =========================
      # Devito fork
      # =========================
      - name: Install GeoSymCodes Devito
        run: |
          pip install git+https://github.com/GeoSymCodes/devito.git

      # =========================
      # PyLops LOCAL
      # =========================
      - name: Install pylops (local)
        run: |
          pip install .

      # =========================
      # Sanity check (IMPORTANTE)
      # =========================
      - name: Debug Devito/PyLops
        run: |
          python - << 'EOF'
          import devito, pylops, inspect
          print("Devito version:", devito.__version__)
          print("Devito path:", inspect.getfile(devito))
          print("PyLops path:", inspect.getfile(pylops))
          EOF

      - name: Test with pytest
        run: |
          pytest
